// =======================
// المتغيرات العامة للـ Products (مختلفة عن app.js)
// =======================
window.productsPage = window.productsPage || {};
window.productsPage.currentProduct = null;
window.productsPage.currentIndex = 0;
window.productsPage.productImages = {};

// قراءة باراميتر من الرابط
function getUrlParameter(name) {
    const urlParams = new URLSearchParams(window.location.search);
    return urlParams.get(name);
}

// =======================
// Lightbox للصور في صفحة Products
// =======================
function products_openLightbox(productKey, index) {
    if (!window.productsPage.productImages[productKey]) {
        console.error('❌ Product not found:', productKey);
        return;
    }

    if (!window.productsPage.productImages[productKey][index]) {
        console.error('❌ Image not found at index:', index);
        return;
    }
    
    window.productsPage.currentProduct = productKey;
    window.productsPage.currentIndex = index;
    
    const lightbox = document.getElementById("lightbox");
    const lightboxImg = document.getElementById("lightbox-img");
    
    if (!lightbox || !lightboxImg) {
        console.error('❌ Lightbox elements not found');
        return;
    }
    
    lightboxImg.src = window.productsPage.productImages[productKey][index];
    lightbox.classList.add("show");
}

function products_closeLightbox() {
    document.getElementById("lightbox").classList.remove("show");
}

function products_changeImage(direction) {
    if (!window.productsPage.productImages[window.productsPage.currentProduct]) {
        console.error('❌ Current product not found');
        return;
    }

    const imgs = window.productsPage.productImages[window.productsPage.currentProduct];
    window.productsPage.currentIndex = (window.productsPage.currentIndex + direction + imgs.length) % imgs.length;
    
    const lightboxImg = document.getElementById("lightbox-img");
    if (lightboxImg) {
        lightboxImg.src = imgs[window.productsPage.currentIndex];
    }
}

// =======================
// إعداد معرض الصور - نفس طريقة HTML
// =======================
function setupImageGallery(container, images, productKey) {
    // نستخدم نفس الطريقة اللي بتشتغل في HTML!
    // بدل window.location.origin نستخدم المسار النسبي مع ../
    const processedImages = images.map(img => {
        // نفس طريقة HTML: "../users/نقشة/products/1-1.png"
        return `../${img}`;
    });

    console.log('✅ Processed images:', processedImages);
    
    window.productsPage.productImages[productKey] = processedImages;
    
    const imgElement = container.querySelector('.product-image');
    if (imgElement) {
        imgElement.style.cursor = 'pointer';
        imgElement.onclick = () => products_openLightbox(productKey, 0);
    }
}

// =======================
// تحميل المنتجات
// =======================
async function loadProducts() {
    const category = getUrlParameter('category');
    const categoryTitle = document.getElementById('categoryTitle');
    const productsGrid = document.getElementById('productsGrid');

    // تعيين عنوان الصفحة
    if (category) {
        categoryTitle.textContent = decodeURIComponent(category);
    } else {
        categoryTitle.textContent = 'جميع المنتجات';
    }

    try {
        // تحميل ملف JSON
        const response = await fetch('../products.json');
        const products = await response.json();

        // فلترة المنتجات حسب الفئة
        let filteredProducts = products;
        if (category) {
            const decodedCategory = decodeURIComponent(category);
            filteredProducts = products.filter(product =>
                product.category && product.category.includes(decodedCategory)
            );
        }

        // عرض المنتجات
        if (filteredProducts.length === 0) {
            productsGrid.innerHTML = '<div class="no-products">لا توجد منتجات في هذا القسم حالياً</div>';
        } else {
            productsGrid.innerHTML = '';
            filteredProducts.forEach((product, index) => {
                const productCard = document.createElement('div');
                productCard.className = 'product-card';
                const productKey = `${product.username}_${product.product_name}_${index}`;

                // بناء HTML للمنتج مع القلب
                productCard.innerHTML = `
                    <div class="heart-icon" onclick="toggleWishlist(event, '${product.username}', '${product.product_name}', '${product.images[0]}', '${product.category}')">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                            <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path>
                        </svg>
                    </div>
                    <div class="image-gallery">
                        <img src="../${product.images[0]}" 
                             alt="${product.product_name}" 
                             class="product-image"
                             onerror="this.src='https://dummyimage.com/300x300/ccc/fff&text=صورة+غير+متوفرة'">
                    </div>
                    <div class="product-info">
                        <h3 class="product-name">${product.product_name || 'منتج بدون اسم'}</h3>
                        <p class="product-description">${product.description || ''}</p>
                        <div class="product-seller">
                            <a href="../users/${encodeURIComponent(product.username)}/profile.html" class="seller-link">
                                ${product.username}
                            </a>
                        </div>
                    </div>
                `;

                productsGrid.appendChild(productCard);

                // إعداد معرض الصور مع المفتاح الفريد
                setupImageGallery(
                    productCard.querySelector('.image-gallery'), 
                    product.images,
                    productKey
                );

                // تحديث حالة القلب بناءً على المفضلة
                updateHeartState(productCard.querySelector('.heart-icon'), product.images[0]);
            });
        }
    } catch (error) {
        console.error('Error loading products:', error);
        productsGrid.innerHTML = '<div class="no-products">حدث خطأ في تحميل المنتجات</div>';
    }
}

// =======================
// تحديث حالة القلب
// =======================
function updateHeartState(heartIcon, imagePath) {
    if (!heartIcon) return;
    
    const wishlist = JSON.parse(localStorage.getItem('wishlist')) || [];
    
    const isInWishlist = wishlist.some(item => {
        const parts = item.split('|||');
        if (parts.length === 4) {
            const itemImage = parts[2];
            return itemImage === imagePath;
        }
        return false;
    });
    
    if (isInWishlist) {
        heartIcon.classList.add('active');
    } else {
        heartIcon.classList.remove('active');
    }
}

function updateAllHearts() {
    const allCards = document.querySelectorAll('.product-card');
    allCards.forEach(card => {
        const heart = card.querySelector('.heart-icon');
        const onclick = heart.getAttribute('onclick');
        
        if (onclick) {
            const match = onclick.match(/toggleWishlist\(event,\s*'[^']*',\s*'[^']*',\s*'([^']*)'/);
            if (match) {
                const imagePath = match[1];
                updateHeartState(heart, imagePath);
            }
        }
    });
}

// =======================
// تشغيل عند تحميل الصفحة
// =======================
document.addEventListener('DOMContentLoaded', function() {
    // تحميل المنتجات
    loadProducts();

    // بعد تحميل المنتجات، انتظر شوية وحدّث القلوب
    setTimeout(updateAllHearts, 100);

    // الاستماع لتحديثات المفضلة
    window.addEventListener('wishlistUpdated', updateAllHearts);
    
    // الاستماع لتغييرات localStorage من تابات أخرى
    window.addEventListener('storage', function(e) {
        if (e.key === 'wishlist') {
            updateAllHearts();
        }
    });
    
    // إعداد اللايت بوكس للصفحة
    const lightbox = document.getElementById('lightbox');
    if (lightbox) {
        // إغلاق عند الضغط خارج الصورة
        lightbox.addEventListener('click', function(e) {
            if (e.target === lightbox) {
                products_closeLightbox();
            }
        });

        // إغلاق بزر ESC
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                products_closeLightbox();
            }
        });
    }
    
    // ربط الدوال بـ window لاستخدامها في HTML
    window.closeLightbox = products_closeLightbox;
    window.changeImage = products_changeImage;
});

// أنيميشن تغيير الصورة
document.addEventListener('DOMContentLoaded', function() {
    const lightboxImg = document.querySelector('#lightbox-img');
    
    // حفظ الدالة الأصلية
    const originalChangeImage = window.changeImage;
    
    // استبدال الدالة بنسخة جديدة مع الأنيميشن
    window.changeImage = function(direction) {
        lightboxImg.style.animation = 'none';
        setTimeout(() => {
            if (direction === 1) {
                lightboxImg.style.animation = 'fadeSlide 0.4s ease';
            } else if (direction === -1) {
                lightboxImg.style.animation = 'fadeSlideReverse 0.4s ease';
            }
        }, 10);
        
        // تنفيذ الدالة الأصلية
        if (originalChangeImage) {
            originalChangeImage(direction);
        }
    };
});